<html>

<title>MySQL Backup | GaP Solutions Pty. Ltd.</title>
<head>
<HTA:APPLICATION
  ID="MySQLBackup"
  BORDER="thin"
  BORDERSTYLE="normal"
  CAPTION="yes"
  MAXIMIZEBUTTON="yes"
  MINIMIZEBUTTON="yes"
  WINDOWSTATE="window"
  NAVIGATABLE="yes"
  INNERBORDERS="no"
  SCROLL="no"
  APPLICATIONNAME="MySQL Backup"
  SINGLEINSTANCE="no"
  SYSMENU="yes"
  SELECTION="no"
  VERSION="2018.10.04" />


<!--  https://github.com/nathan026/MySQLBackup -->
<!--  https://drive.google.com/drive/folders/1ecctYjAjxjwJwYmYh4YI9GT-_Ir9SbL2 -->
<style>

BODY {
    background-color: #333333;
	font-family: Verdana;
	font-size: 15px;
	color: cbcbcb;
    margin: 0;
	}

a:visited {
	color: Black;
	text-decoration: none;
	}

h1, h2, h3, h4, h5, h6 {
	margin-bottom: 0.5;
	}

div.Blanket_Div {
	visibility:hidden;
	Background:Black;
	filter:alpha(opacity=80);
	opacity:0.2;
	z-index:9999;
	height:100%;
	width:100%;
	position:absolute;
	text-align:center;
	line-height:600px;
	}

div.UpdateBar_Div {
	visibility: hidden;
	background: #ffcc66;
	color: Black;
	font-size: 20px;
	top: 0px;
	text-align: center;
	position: absolute;
	width: 100%;
	height: 30px;
}

div.Header_Div {
	height:10%;
	background-color:#329f50;
	box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
	color: White;
	}

div.Footer_Div {
	background-color:#1a1a1a;
	color:#9f9f9f;
	bottom:0px;
	height:8%;
	left:0px;
	position:absolute;
	text-align:left;
	width:100%;
	}
	
div.Version_Div {
	background-color:#1a1a1a;
	color:#9f9f9f;
	bottom:0px;
	height:8%;
	right:0px;
	position:absolute;
	text-align:right;
	width:50%;
	}
	
</style>
 
<script language="VBScript">
window.resizeTo 500,550
window.moveTo (screen.Width - 500)/2, ((screen.Height - 550)/2)-20


On Error Resume Next
Dim fso, tempfile, tfolder, strMySQL, strSQLUser, strSQLFile, strBackup, strMySQLdump, strMySQLcheck, strAppVer, loaded, http_obj, stream_obj, objShell, strUpdate
Dim strCommandLine, strHTA

Set objWMIService 		= GetObject("winmgmts:" & "{impersonationLevel=impersonate}!\\.\root\cimv2")
Set fso 				= CreateObject("Scripting.FileSystemObject")
Set objShell 			= CreateObject("WScript.Shell")
Set UAC 				= CreateObject("Shell.Application")
Set tfolder 			= fso.GetSpecialFolder(TemporaryFolder)
set http_obj 			= CreateObject("Microsoft.XMLHTTP")
set stream_obj 			= CreateObject("ADODB.Stream")

strSQLUser     = tfolder & "\sqluser"
strTools       = tfolder & "\sqlTools"
strSQLFile     = tfolder & "\mysqldump.sql"
strBackup      = tfolder & "\MySQL_Backup"
strAppVer      = MySQLBackup.Version
strHTA         = Self.location.pathname
strCommandLine = MySQLBackup.CommandLine


Const TemporaryFolder = 2

Sub Window_OnLoad
	AppVersion.InnerHTML = strAppVer

	Set colIP = objWMIService.ExecQuery ("Select * From Win32_NetworkAdapterConfiguration Where IPEnabled = True")
	Set colCOMPNAME = objWMIService.ExecQuery( "Select * from Win32_ComputerSystem" )

	For each objCOMPNAME in colCOMPNAME
		CompName.innerHTML = objCOMPNAME.Name
	next

	On Error Resume Next
	For each objitem in colIP
		IP.innerHTML = Join(objitem.IPAddress, " . . . . . . ")
		Exit For
	Next
	On Error Goto 0

	If fso.FileExists("C:\Program Files\MySQL\MySQL Server 5.5\bin\mysql.exe") Then
		strMySQL      = """C:\Program Files\MySQL\MySQL Server 5.5\bin\mysql.exe"""
		strMySQLadmin = """C:\Program Files\MySQL\MySQL Server 5.5\bin\mysqladmin.exe"""
		strMySQLdump  = """C:\Program Files\MySQL\MySQL Server 5.5\bin\mysqldump.exe"""
		strMySQLcheck = """C:\Program Files\MySQL\MySQL Server 5.5\bin\mysqlcheck.exe"""
		MySQLInstall = True

	ElseIf fso.FileExists("C:\Program Files (x86)\MySQL\MySQL Server 5.5\bin\mysql.exe") Then
		strMySQL      = """C:\Program Files (x86)\MySQL\MySQL Server 5.5\bin\mysql.exe"""
		strMySQLadmin = """C:\Program Files (x86)\MySQL\MySQL Server 5.5\bin\mysqladmin.exe"""
		strMySQLdump  = """C:\Program Files (x86)\MySQL\MySQL Server 5.5\bin\mysqldump.exe"""
		strMySQLcheck = """C:\Program Files (x86)\MySQL\MySQL Server 5.5\bin\mysqlcheck.exe"""
		MySQLInstall = True
	Else
		strMySQL      = "echo"
		strMySQLadmin = "echo"
		strMySQLdump  = "echo"
		strMySQLcheck = "echo"
		document.getElementById("start").disabled=true
		MsgBox "MySQL could not be found", , "Error!"
	End If

	setTimeout "CheckUpdate", 100, "VBScript"
	call CheckMySQL1()
	
End Sub

Sub CheckMySQL1
			Dim DNSResult
			DB1Check.innerhtml = "--"
			DB1Check.style.color = "Orange"
			
			On Error Resume Next
			DNSResult = objShell.run (strMySQL & " --user=gap -pgap -h " & Host_IP.Value & " -e ""select '1';""", 0, True)
			On Error Goto 0
			
			IF strMySQL = "echo" Then
				DB1Check.innerhtml = "??"
				DB1Check.style.color = "Orange"
			ElseIf	DNSResult = 0 Then
				DB1Check.innerhtml = "OK"
				DB1Check.style.color = "Green"
			Else
				DB1Check.innerhtml = "??"
				DB1Check.style.color = "Orange"
			End If
End Sub

Sub CheckMySQL2
			Dim DNSResult
			DB2Check.innerhtml = "--"
			DB2Check.style.color = "Orange"
			
			On Error Resume Next
			DNSResult = objShell.run (strMySQL & " --user=gap -pgap -h " & Target_IP.Value & " -e ""select '1';""", 0, True)
			On Error Goto 0
			
			IF strMySQL = "echo" Then
				DB2Check.innerhtml = "??"
				DB2Check.style.color = "Orange"
			ElseIF DNSResult = 0 Then
				DB2Check.innerhtml = "OK"
				DB2Check.style.color = "Green"
			Else
				DB2Check.innerhtml = "??"
				DB2Check.style.color = "Orange"
			End If
End Sub

Sub start
	Blanket_Div.style.visibility="visible"
	
	Set objFile = fso.CreateTextFile(strSQLUser)
		strLine = "GRANT USAGE ON *.* TO 'gap'@'localhost' IDENTIFIED BY 'gap'; GRANT ALL PRIVILEGES ON *.* TO 'gap'@'localhost' WITH GRANT OPTION; FLUSH PRIVILEGES;" & _
				  " GRANT USAGE ON *.* TO 'gap'@'%' IDENTIFIED BY 'gap'; GRANT ALL PRIVILEGES ON *.* TO 'gap'@'%' WITH GRANT OPTION;" & _
				  " GRANT USAGE ON *.* TO 'gappde'@'localhost' IDENTIFIED BY 'gappde'; GRANT ALL PRIVILEGES ON *.* TO 'gappde'@'localhost' WITH GRANT OPTION;" & _
				  " SET PASSWORD FOR 'gappde'@'localhost' = OLD_PASSWORD('gappde'); FLUSH PRIVILEGES;" & _
				  " CREATE DATABASE IF NOT EXISTS " & Target_DB.Value & "; "
				  '' " DROP DATABASE IF EXISTS " & Target_DB.Value & ";"
	objFile.WriteLine strLine
	objFile.Close

    If (mode(0).Checked) Or (safetybackup.Checked) Then ''BACKUP
		If Not fso.FolderExists(strBackup) Then
			fso.CreateFolder strBackup
		End If

		strBackupName = "MySQL_dump" & replace(date,"/","")
		If Not safetybackup.Checked then	'' Safety Backup Checked? Take Backup...
			strBackupName = InputBox("Save backup as...", "Save As", "MySQL_dump" & replace(date,"/",""))
		End If
		
		IF Not strBackupName ="" Then
			objShell.Run strMySQLdump &_
			" --user=gap -pgap --host=" & Host_IP.Value &_
			" --add-drop-database --hex-blob=TRUE --force --databases " & Host_DB.Value & " -r """ & strBackup & "\" & strBackupName & ".sql" & "", 0, True

			If Not safetybackup.Checked then	'' Safety Backup Checked? Take Backup...
				MsgBox "Backup Complete!", , "Complete!"
				UAC.Open strBackup
			End If
		End If
    End If

	If mode(1).Checked Then ''RESTORE
		If fLocation.Value ="" Then
			MsgBox "No File Selected!", , "Error!"
		Else
			objShell.Run "cmd /C """ & strMySQL & " --user=root -proot -h " & Target_IP.Value & " < " & chr(34) & strSQLUser & chr(34), 0, True
			objShell.Run "cmd /C """ & strMySQL & " --user=gap -pgap -h " & Target_IP.Value & " --database=" & Target_DB.Value & " < " & chr(34) & fLocation.Value & chr(34), 0, True
			MsgBox "Restore Complete!", , "Complete!"
		End If
	End If

	If mode(2).Checked Then ''MIGRATE
		objShell.Run strMySQLdump & " --user=gap -pgap -h " & Host_IP.Value & " " & Host_DB.Value & " -f -r " & strSQLFile, 0, True
		objShell.Run "cmd /C """ & strMySQL & " --user=root -proot -h " & Target_IP.Value & " < " & chr(34) & strSQLUser & chr(34), 0, True
		objShell.Run "cmd /C """ & strMySQL & " --user=gap -pgap -h " & Target_IP.Value & " " & Target_DB.Value & " < " & chr(34) & strSQLFile & chr(34), 0, True
		MsgBox "Migration Complete!", , "Complete!"
    End If

	If mode(3).Checked Then ''CHECK + TOOLS
		call Tools()
    End If

	Blanket_Div.style.visibility="Hidden"
End Sub


Sub CheckUpdate ''CHECK FOR UPDATES
	Dim lenLatestVer, strCurrentVer, strLatestver

	Checking.style.visibility="Visible"
		strCurrentVer = Split( MySQLBackup.Version )(0)
		strUpdate = LEFT(TextFromHTML( "https://raw.githubusercontent.com/nathan026/MySQLBackup/master/version.txt?noone=" & timer ), 500)
		strLatestVer  = LEFT(strUpdate,10)
		
		If (Replace(strLatestver,".","") > Replace(strCurrentVer,".","")) Then
			call UpdateNotification()
		End If

	Checking.style.visibility="Hidden"
End Sub

Sub Help
	Blanket_Div.style.visibility="Visible"

	result = msgbox("   Your Version: " & MySQLBackup.Version & vbCrLf &_
	"Latest Version: " & strUpdate & "..." & vbCrLf & vbCrLf & cvCrLf & "Do you want to open the user manual?", vbYesNo, "Help!")

	Select Case result
	Case vbYes
		objShell.run("https://docs.google.com/document/d/18HCIYXgQLZNelujriRDQbpEuopKLgJC44QNgoiwbR8M/edit?usp=sharing")
	Case vbNo
	End Select

	Blanket_Div.style.visibility="Hidden"
End Sub

Sub Download ''DOWNLOAD UPDATE
	Blanket_Div.style.visibility="visible"
	
	If Not IsAdmin( True ) Then
		msgbox "Need permission to write file...", , "Warning!"
	End If

		http_obj.open "GET", "https://raw.githubusercontent.com/nathan026/MySQLBackup/master/DBBackup.hta?noonce=" & timer, False
		http_obj.send

		stream_obj.type = 1
		stream_obj.open
		stream_obj.write http_obj.responseBody
		stream_obj.savetofile self.location.pathname, 2
		objShell.run """" & self.location.pathname & """"
		Self.Close()
	Blanket_Div.style.visibility="Hidden"
End Sub

Function TextFromHTML( myURL )
    Dim objHTTP
    TextFromHTML = ""
    On Error Resume Next
    Set objHTTP = CreateObject( "WinHttp.WinHttpRequest.5.1" )
    objHTTP.Open "GET", myURL
    objHTTP.Send
    If Err Then gvbConnected = False
    ' Check if the result was valid, and if so return the result
    If objHTTP.Status = 200 Then TextFromHTML = objHTTP.ResponseText
    Set objHTTP = Nothing
    On Error Goto 0
End Function

Function IsAdmin( showMessage )
    Dim intRC
    Dim objUAC
    
    IsAdmin = False

	On Error Resume Next
	' intRC = objShell.Run( "CMD /C OPENFILES > NUL 2>&1", 7, True ) ' CHeck for Admin
	 intRC = objShell.Run( "cmd /C echo. > """ & replace(strHTA,".","") & ".1""", 7, True ) ' Check for Write Privileges to current folder
	If Err Then intRC = 1
	On Error Goto 0
	
	If intRC = 0 Then
		intRC = objShell.Run( "cmd /C DEL /F /Q """ & replace(strHTA,".","") & ".1""", 7, True )	    
		IsAdmin = True
	Else
		intRC = objShell.Run( "cmd /C DEL /F /Q """ & replace(strHTA,".","") & ".1""", 7, True )
		IsAdmin = False
		' Strip HTA file name or path from command line
		If InStr( strCommandLine, """" & strHTA & """" ) = 1 Then
			strCommandLine = Mid( strCommandLine, Len( strHTA ) + 3 )
		ElseIf InStr( strCommandLine, strHTA ) = 1 Then
			strCommandLine = Mid( strCommandLine, Len( strHTA ) + 1 )
		ElseIf InStr( strCommandLine, """" & fso.GetFileName( strHTA ) & """" ) = 1 Then
			strCommandLine = Mid( strCommandLine, Len( strHTA ) + 3 )
		ElseIf InStr( strCommandLine, fso.GetFileName( strHTA ) ) = 1 Then
			strCommandLine = Mid( strCommandLine, Len( strHTA ) + 1 )
		ElseIf InStr( strCommandLine, fso.GetFileName( strHTA ) ) > 0 Then
			strCommandLine = Mid( strCommandLine, InStr( strHTA ) + Len( strHTA ) + 1 )
			If Left( strCommandLine, 1 ) = """" Then strCommandLine = Mid( strCommandLine, 2 )
	Else
		' Error: do nothing, the HTA will close
	End If
	strCommandLine = Replace( Trim( strCommandLine ), """", """""" )
	' Elevate privileges
	Set objUAC = CreateObject( "Shell.Application" )
	objUAC.ShellExecute "MSHTA.EXE", """" & strHTA & """ /NOADMIN " & strCommandLine, "", "runas", 1
	Set objUAC = Nothing
	window.close True
	End If
End Function


''TOOLS
Sub Tools
	Blanket_Div.style.visibility="visible"

	If tools99.selectedIndex = 0 Then '' MySQL Check and Repair
		objShell.Run "cmd /c " & strMySQL & " -u gap -pgap -h " & Host_IP.Value & "-e """"flush hosts;""""", 0, True
		objShell.Run "cmd /c " & strMySQLcheck & " --user=gap -pgap -h " & Host_IP.Value & " " & Host_DB.Value & " --auto-repair --optimize --force --use-frm >%temp%\MySQLCheck.log", 0, True
		objShell.Run "notepad.exe %temp%\MySQLCheck.log", 1, False
		MsgBox "Check and Repair Complete!", , "Complete!"
	End If

	IF tools99.selectedIndex = 1 Then  '' Create GaP User
		result = MsgBox("This will create the gap users in MySQL" & vbCrLf & vbCrLf & "Do you want to continue?", vbYesNo, "Create gap users")

		Select Case result
		Case vbYes
			Set objFile2 = fso.CreateTextFile(strTools)
			strLine = "GRANT USAGE ON *.* TO 'gap'@'localhost' IDENTIFIED BY 'gap'; GRANT ALL PRIVILEGES ON *.* TO 'gap'@'localhost' WITH GRANT OPTION;" & _
					  " GRANT USAGE ON *.* TO 'gap'@'%' IDENTIFIED BY 'gap'; GRANT ALL PRIVILEGES ON *.* TO 'gap'@'%' WITH GRANT OPTION;" & _
					  " GRANT USAGE ON *.* TO 'gappde'@'localhost' IDENTIFIED BY 'gappde'; GRANT ALL PRIVILEGES ON *.* TO 'gappde'@'localhost' WITH GRANT OPTION;" & _
					  " SET PASSWORD FOR 'gappde'@'localhost' = OLD_PASSWORD('gappde'); FLUSH PRIVILEGES;"
			objFile2.WriteLine strLine
			objFile2.Close
			
			objShell.Run "cmd /c " & strMySQL & " -u root -proot -h " & Host_IP.Value & " < " & strTools, 0, True
			MsgBox "gap database users created!", , "Complete!"
		Case vbNo
		End Select
	End If

	IF tools99.selectedIndex = 2 Then  '' Convert to InnoDB
		result = MsgBox("This will convert all table engines to InnoDB" & vbCrLf & "InnoDB is the recommended table engine for deliqs" & vbCrLf & vbCrLf & "Do you want to continue?", vbYesNo, "Convert to InnoDB")

		Select Case result
		Case vbYes
			Set objFile2 = fso.CreateTextFile(strTools)
			objFile2.WriteLine "SELECT CONCAT('ALTER TABLE " & Host_DB.Value & ".', TABLE_NAME,' ENGINE=InnoDB;') FROM INFORMATION_SCHEMA.TABLES WHERE ENGINE='MyISAM' AND table_schema = '" & Host_DB.Value & "' ;"
			objFile2.Close
			
			objShell.Run "cmd /C echo -- ## List of tables to be converted to InnoDB ##>" & strTools & ".sql" , 0, True
			objShell.Run "cmd /C echo -- >>" & strTools & ".sql" , 0, True
			
			objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " < " & strTools & " >>" & strTools & ".sql", 0, True
			objShell.Run "notepad.exe " & strTools & ".sql", 1, False
			objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -h " & Host_IP.Value & " " & Host_DB.Value &" < " & strTools & ".sql", 0, True
		Case vbNo
		End Select
	End If

	IF tools99.selectedIndex = 3 Then  '' Update Current Cost
		result = MsgBox("This will update the current cost for all products"  & vbCrLf & vbCrLf & "Do you want to continue?", vbYesNo, "Update Current Cost")

		Select Case result
		Case vbYes
			Set objFile2 = fso.CreateTextFile(strTools)
			strLine = "UPDATE PLU LEFT JOIN ( SELECT dc.* FROM DealCost dc INNER JOIN ( SELECT bdc.PLUG_UID, MIN(bdc.Cost / POWER(10, bdc.CostDecimals)) AS Cost" & _
					  " FROM DealCost AS bdc WHERE bdc.Start<=NOW() AND bdc.End>NOW() GROUP BY bdc.PLUG_UID ) AS b ON b.Cost=(dc.Cost / POWER(10, dc.CostDecimals))" & _
					  " AND b.PLUG_UID=dc.PLUG_UID AND dc.Start<=NOW() AND dc.End>=NOW() ) AS dc ON PLU.G_UID=dc.PLUG_UID LEFT JOIN" & _
					  " ( SELECT c.Name, c.Description, c.EndDate, cp.PLUG_UID, cp.NewCost AS Cost, cp.NewCostDecimals AS CostDecimals FROM" & _
					  " ( SELECT cp.PLUG_UID, MIN(cp.NewPrice) AS NewPrice FROM Campaign c INNER JOIN CampaignStore cs ON c.ID=cs.CampaignID AND" & _
					  " cs.StoreID=IFNULL((select value from settings where Keyname='StoreID' and Section='General'),0) INNER JOIN CampaignPLU cp" & _
					  " ON c.ID=cp.CampaignID LEFT JOIN PLU p ON p.G_UID=cp.PLUG_UID AND p.StoreID=cs.StoreID WHERE c.CampaignType=1 AND c.Active=1" & _
					  " AND c.Deleted=0 AND c.StartDate<=NOW() AND c.EndDate>=NOW() GROUP BY cp.PLUG_UID) AS mcp INNER JOIN CampaignPLU cp ON" & _
					  " mcp.PLUG_UID=cp.PLUG_UID AND cp.NewPrice=mcp.NewPrice INNER JOIN Campaign c ON c.ID=cp.CampaignID GROUP BY cp.PLUG_UID HAVING cp.NewCost>0)" & _
					  " AS c ON c.PLUG_UID=PLU.G_UID SET PLU.CurrentCost = COALESCE(dc.Cost, c.Cost, 0), PLU.CurrentCostDecimals =" & _
					  " COALESCE(dc.CostDecimals, c.CostDecimals, PLU.CostDecimals, 3), PLU.CurrentCostDesc = COALESCE(dc.Description, c.Description, 'Normal')," & _
					  " PLU.CurrentCostEnd = COALESCE(dc.End, c.EndDate), PLU.DealCostIdentifier = dc.Identifier, PLU.CurrentCostUpdated = NOW()," & _
					  " PLU.LastUpdatedByUser = 'support@gapsolutions.com.au' WHERE PLU.StoreID=IFNULL((select value from settings where Keyname='StoreID' and" & _
					  " Section='General'),0) AND (PLU.CurrentCost IS NULL OR PLU.CurrentCost<>COALESCE(dc.Cost, c.Cost, 0));"
			objFile2.WriteLine strLine
			objFile2.Close
			objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools, 0, True
			MsgBox "Current Costs have been updated!", , "Complete!"
		Case vbNo
		End Select
	End If
	
	IF tools99.selectedIndex = 4 Then  '' Reset Database
		result = MsgBox("This will TRUNCATE all* tables in the database" & vbCrLf & "Settings and sales related tables will be kept" & vbCrLf & vbCrLf & "Do you want to continue?", vbYesNo, "Reset Database")

		Select Case result
		Case vbYes
			Set objFile2 = fso.CreateTextFile(strTools)
			strLine = "SELECT value FROM checkoutsettings WHERE section='General' AND KeyName='Master' AND (StoreID=(SELECT value FROM settings" & _
					  " WHERE section='General' AND KeyName='StoreID') OR StoreID=0) ORDER BY StoreID DESC LIMIT 1;"
			objFile2.WriteLine strLine
			objFile2.Close
			objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools & " >" & strTools & "mastercheck", 0, True

			Set objMaster = fso.OpenTextFile (strTools & "mastercheck", 1)
			Do Until objMaster.AtEndOfStream
			strMaster = objMaster.ReadLine
			Loop

			IF (strMaster="True") THEN
				MsgBox "This database is a Master. Cannot reset database."
			ELSE
				Set objFile2 = fso.CreateTextFile(strTools)
				strLine =	"SET FOREIGN_KEY_CHECKS = 0;" & _
							" DELETE FROM " & Host_DB.Value & ".checkoutsettings WHERE section='LastUpdate';" & _
							" SELECT CONCAT('TRUNCATE TABLE " & Host_DB.Value & ".',TABLE_NAME,';') FROM INFORMATION_SCHEMA.TABLES WHERE table_schema = '" & _
							Host_DB.Value & _
							"' AND TABLE_TYPE='BASE TABLE' AND TABLE_NAME NOT IN ('checkoutsettings','rsaleheader','rsaledetail','saleheader','saledetail','salepayment','eftreceipt');" & _
							" SET FOREIGN_KEY_CHECKS = 1;"
				objFile2.WriteLine strLine
				objFile2.Close
				objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value &  " < " & strTools & " >" & strTools & "refresh", 0, True
				objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value &  " < " & strTools & "refresh", 0, True
				MsgBox "Reset Database Complete", , "Complete!"
			END IF

		Case vbNo
		End Select
	End If

	IF tools99.selectedIndex = 5 Then  '' Unlock Operators
		result = MsgBox("This will log out all operators from the server and unlock locked operators"  & vbCrLf & vbCrLf & "Do you want to continue?", vbYesNo, "Unlock Operators")

		Select Case result
		Case vbYes
			Set objFile2 = fso.CreateTextFile(strTools)
			strLine = "UPDATE operator SET locked=0, loggedin=0;"
			objFile2.WriteLine strLine
			objFile2.Close
			objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools, 0, True
			MsgBox "All Operators Unlocked", , "Complete!"
		Case vbNo
		End Select
	End If

	IF tools99.selectedIndex = 6 Then  '' Send to Foreign Scales
		result = MsgBox("This will flag all products with 'Export to Foreign Scale' to be sent." & vbCrLf  & vbCrLf & "Do you want to continue?", vbYesNo, "Send to Foreign Scales")

		Select Case result
		Case vbYes
			Set objFile2 = fso.CreateTextFile(strTools)
			strLine = "INSERT INTO ModifyPlu ( PLU, PLUG_UID, ModifyOn, ModifiedUtc, ModifyWhat, NewPrice, NewCost )" & _
					  " SELECT plu.plu, plu.g_uid, CURDATE(), UTC_TIMESTAMP(),'4', plu.price, plu.cost FROM deliqs.plu" & _
					  " LEFT JOIN campaignplu ON plu.plu=campaignplu.plu" & _
					  " WHERE plu.deleted=0 AND plu.active=1 AND plu.sendtoscale=1 AND" & _ 
					  " plu.storeid=IFNULL((select value from settings where Keyname='StoreID' and Section='General'),0);"
			objFile2.WriteLine strLine
			objFile2.Close
			objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools, 0, True
			MsgBox "Products flaged to send", , "Complete!"
		Case vbNo
		End Select
	End If

	IF tools99.selectedIndex = 7 Then  '' Delete Product by Master GUID
	strMasterPluGUID = InputBox("Paste MasterPLUG_UID line to delete product", , "Delete Product by Master PLUG_UID")

		IF Not strMasterPluGUID="" Then
			result = MsgBox("This will delete any products which are linked to this Master GUID" & vbCrLf  & vbCrLf & "Do you want to continue?", vbYesNo, "Delete Product by Master PLUG_UID")

			Select Case result
			Case vbYes
				Set objFile2 = fso.CreateTextFile(strTools)
				objFile2.WriteLine strMasterPluGUID & " DELETE FROM PLU WHERE masterplug_uid=@MasterPluG_UID;"
				objFile2.Close
				objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools, 0, True
				MsgBox "Delete Product by Master PLU_GUID Complete", , "Complete!"
			Case vbNo
			End Select
		End If
	End If

	IF tools99.selectedIndex = 8 Then  '' Remove Orphaned Sales
		result = MsgBox("This will remove all open sales from all operators" & vbCrLf  & vbCrLf & "Do you want to continue?", vbYesNo, "Remove Orphaned Sales")

		Select Case result
		Case vbYes
			Set objFile2 = fso.CreateTextFile(strTools)
			strLine = 	"SET FOREIGN_KEY_CHECKS = 0;" & _
						" DELETE FROM rsaleheader  WHERE trantype NOT IN ('16','36') AND DATE(createdlocal)<>DATE(NOW());" & _
						" DELETE FROM rsaledetail  WHERE saleheaderid NOT IN (select saleheaderid from rsaleheader);" & _
						" DELETE FROM rsalepayment WHERE saleheaderid NOT IN (select saleheaderid from rsaleheader);" & _
						" DELETE FROM rcampaignhit WHERE saleheaderid NOT IN (select saleheaderid from rsaleheader);" & _
						" DELETE FROM reftreceipt WHERE saleheaderid NOT IN (select saleheaderid from rsaleheader);" & _
						" DELETE FROM rsalefuel WHERE saleheaderid NOT IN (select saleheaderid from rsaleheader);" & _
						" SET FOREIGN_KEY_CHECKS = 1;"
			objFile2.WriteLine strLine
			objFile2.Close
			objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools, 0, True
			MsgBox "Remove Orphaned Sales Complete", , "Complete!"
		Case vbNo
		End Select
	End If

	IF tools99.selectedIndex = 9 Then  '' Delete All Products
		result = MsgBox("This will TRUNCATE 'plu', 'plulocaltion', 'nutrifacts' from database" & vbCrLf  & vbCrLf & "Do you want to continue?", vbYesNo, "Delete All Products")

		Select Case result
		Case vbYes
			Set objFile2 = fso.CreateTextFile(strTools)
			strLine = 	"SET FOREIGN_KEY_CHECKS = 0;" & _
						" TRUNCATE TABLE plu;" & _
						" TRUNCATE TABLE plulocation;" & _
						" TRUNCATE TABLE nutrifacts;" & _
						" SET FOREIGN_KEY_CHECKS = 1;"
			objFile2.WriteLine strLine
			objFile2.Close
			objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools, 0, True
			MsgBox "Delete All Products Complete", , "Complete!"
		Case vbNo
		End Select
	End If

	IF tools99.selectedIndex = 10 Then  '' Cleanup Old Data
		result = MsgBox("This will DELETE dealcosts and campaigns which ended more than 1 month ago from database" & vbCrLf  & vbCrLf & "Do you want to continue?", vbYesNo, "Cleanup Old Data")

		Select Case result
		Case vbYes
			Set objFile2 = fso.CreateTextFile(strTools)
			strLine = 	"SET FOREIGN_KEY_CHECKS = 0;" & _
						" DELETE d.* FROM dealcost d" & _
							" LEFT JOIN plu p ON p.g_uid=d.plug_uid" & _
							" WHERE (d.end<(CURDATE() - INTERVAL 7 DAY) OR p.id is null);" & _
						" DELETE cpsa.* FROM campaignplustoreacceptance cpsa" & _
							" LEFT JOIN campaign c ON c.id=cpsa.campaignid" & _
							" WHERE c.campaigntype>0;" & _
						" DELETE FROM campaignplustoreacceptance WHERE appliedutc IS NOT NULL;" & _
						" DELETE c, cp, cs, cpg, cpp FROM campaign c" & _
							" LEFT JOIN campaignplu cp ON c.id=cp.campaignid" & _
							" LEFT JOIN campaignstore cs ON c.id=cs.campaignid" & _
							" LEFT JOIN combopricegroup cpg ON c.id=cpg.CampaignID" & _
							" LEFT JOIN combopriceplu cpp ON cpg.G_UID=cpp.GroupG_UID" & _
							" LEFT JOIN campaignplustoreacceptance cpsa ON c.id=cpsa.campaignid AND cp.plug_uid=cpsa.plug_uid" & _
							" WHERE c.EndDate<(CURDATE() - INTERVAL 1 MONTH) AND cpsa.id IS NULL;" & _
						" DELETE cb.* FROM checkoutbutton cb LEFT JOIN checkoutform cf ON cf.id=cb.checkoutformid WHERE cf.id IS NULL;" & _
						" DELETE pluapn.* FROM pluapn LEFT JOIN plu ON plu.g_uid=pluapn.plug_uid WHERE plu.g_uid IS NULL;" & _
						" DELETE FROM prepack WHERE packedon<(CURDATE() - INTERVAL 1 YEAR);" & _
						" DELETE  d.*, h.* FROM deliorderdetail d" & _
							" LEFT JOIN deliorderheader h ON d.headerid=h.id" & _
							" WHERE h.created<(CURDATE() - INTERVAL 14 DAY)" & _
							" OR h.id is null;" & _
						" TRUNCATE TABLE deliorderheader_h;" & _
						" TRUNCATE TABLE deliorderdetail_h;" & _
						" TRUNCATE TABLE plupricehistory;" & _
						" SET FOREIGN_KEY_CHECKS = 1;"
			objFile2.WriteLine strLine
			objFile2.Close
			objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools, 0, True
			MsgBox "Cleanup Old Data Complete", , "Complete!"
		Case vbNo
		End Select
	End If
	
	IF tools99.selectedIndex = 11 Then  '' Check Operator Logged In
			Set objFile2 = fso.CreateTextFile(strTools)
			objFile2.WriteLine "SELECT ShortName, LastUsedIP FROM operator WHERE LoggedIn=1;"
			objFile2.Close
			objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools & " >" & strTools & "results", 0, True
			
			set objFile3 = fso.OpenTextFile(strTools & "results",1)
			tempdata = objFile3.readAll()
			MsgBox tempdata, , "Operators Logged In"
	End If
	
	IF tools99.selectedIndex = 12 Then  '' Update Store name and address for all cassettes
	strStoreName = InputBox("Store Name...")
	strStoreAddress = InputBox("Store Address...")

		IF Not strStoreName="" Then
			result = MsgBox("Store Name: " & strStoreName & vbCrLf &_
							 "Store Address: " & strStoreAddress & vbCrLf & vbCrLf & "Do you want to continue?", vbYesNo, "Change Store Name and Address")

			Select Case result
			Case vbYes
				Set objFile2 = fso.CreateTextFile(strTools)
				objFile2.WriteLine "UPDATE scalelabelcassette SET StoreName=""" & strStoreName & """, StoreAddress=""" & strStoreAddress & """; "
				objFile2.Close
				objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools, 0, True
				MsgBox "Updating Store Name and Address Complete", , "Complete!"
			Case vbNo
			End Select
		End If
	End If
	
	IF tools99.selectedIndex = 13 Then  '' List Table Sizes in database
						Set objFile2 = fso.CreateTextFile(strTools)
			strLine = 	"SELECT table_name, round(((data_length + index_length) / 1024 / 1024), 2) `Size in MB`" & _
						" FROM information_schema.TABLES" & _
						" WHERE table_schema = '" & Host_DB.Value & "'"& _
						" ORDER BY (data_length + index_length) DESC;"
			objFile2.WriteLine strLine
			objFile2.Close
			objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools & " >" & strTools & "results", 0, True
			objShell.Run "notepad.exe " & strTools & "results", 1, False
	End If

	If safetybackup.Checked then	'' Safety Backup Checked? Show Backup...
		UAC.Open strBackup
	End If

	Blanket_Div.style.visibility="Hidden"
End Sub

Sub VersionDetail
Blanket_Div.style.visibility="Visible"
MySQLstate = "False"
ConnectorState = "False"
DotNetState = "Flase"
StoreNameState1 = "No Store Details Available"
eziscaleState = ""
eziscale45State = ""
eziposState = ""
objFileSerial = ""

	''MySQL Check
	On Error Resume Next
	MySQLstate = objWMIService.Get("Win32_Service.Name='MySQL55'").State
	On Error Goto 0
	
	''Connector Check
	Const HKEY_LOCAL_MACHINE = &H80000002
	
	Set oReg=GetObject("winmgmts:{impersonationLevel=impersonate}!\\.\root\default:StdRegProv")
	strKeyPath = "SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall"
	oReg.EnumKey HKEY_LOCAL_MACHINE, strKeyPath, arrSubKeys
	
	On Error Resume Next
	For Each subkey In arrSubKeys
		keyname = ""
		keyname = objShell.RegRead("HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\" & subkey & "\DisplayName")
		If keyname = "MySQL Connector Net 6.9.8" then
			ConnectorState = "True"
		End If
	Next
	On Error Goto 0
	
	''DotNet Check
	strKeyPath = "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full"
	oReg.EnumKey HKEY_LOCAL_MACHINE, strKeyPath, arrSubKeys
	
	On Error Resume Next
	For Each subkey In arrSubKeys
		keyname = ""
		keyname = objShell.RegRead("HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full\Release")
		If keyname = "378389" then
			DotNetState = "True"
		Elseif keyname > "378389" then
			DotNetState = "True 4.5+"
		End If
	Next
	On Error Goto 0
	
	''ezi-scale Version Check
	On Error Resume Next
	eziscale45State = fso.GetFileVersion("C:\Program Files\GaP Solutions Pty Ltd\ShopEzi Scales\Ezi-Scale45.exe")
	eziscale45State = fso.GetFileVersion("C:\Program Files (x86)\GaP Solutions Pty Ltd\ShopEzi Scales\Ezi-Scale45.exe")
	eziscaleState = fso.GetFileVersion("C:\Program Files\GaP Solutions Pty Ltd\ShopEzi Scales\Ezi-Scale.exe")
	eziscaleState = fso.GetFileVersion("C:\Program Files (x86)\GaP Solutions Pty Ltd\ShopEzi Scales\Ezi-Scale.exe")
	eziposState = fso.GetFileVersion("C:\Program Files\GaP Solutions Pty Ltd\ezi-pos\ezi-pos.exe")
	eziposState = fso.GetFileVersion("C:\Program Files (x86)\GaP Solutions Pty Ltd\ezi-pos\ezi-pos.exe")
	On Error Goto 0
	
	''StoreName Check
	If strMySQL = True Then
		Set objFile2 = fso.CreateTextFile(strTools)
		strLine = 	"select shortname from store where id=IFNULL((select value from settings where Keyname='StoreID' and Section='General'),0);"
		objFile2.WriteLine strLine
		objFile2.Close
		objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools & " >" & strTools & "results", 0, True
		set objFile3 = fso.OpenTextFile(strTools & "results",1)
		StoreNameState1 = objFile3.readAll()	
		
		Set objFile2 = fso.CreateTextFile(strTools)
		strLine2 = 	"select IFNULL(storename,'') from scalelabelcassette where storename not in ('');"
		objFile2.WriteLine strLine2
		objFile2.Close
		objShell.Run "cmd /C " & strMySQL & " --user=gap -pgap -sN -h " & Host_IP.Value & " " & Host_DB.Value & " < " & strTools & " >" & strTools & "results", 0, True
		set objFile3 = fso.OpenTextFile(strTools & "results",1)
		StoreNameState2 = objFile3.readAll()	
	end if
	
	''SerialNo Check
	On Error Resume Next
	set objFileSerial = fso.OpenTextFile("c:\serialno.txt",1)
		SerialState = objFileSerial.readAll()	
	On Error Goto 0
	
	''Results
	Msgbox	StoreNameState1  & vbCrLf &_
			"MySQL 5.5:       " & MySQLstate & vbCrLf &_
			"Connector 6.3.9: " & ConnectorState & vbCrLf &_
			"DotNet 4.5:      " & DotNetState & vbCrLf &_
			"ezi-scale:       " & eziscaleState & vbCrLf &_
			"ezi-scale45:     " & eziscale45State & vbCrLf &_
			"ezi-pos:         " & eziposState & vbCrLf &_
			"SerialNo:        " & SerialState & vbCrLf &_
			":: Alternative Store Name ::" & vbCrLf &_
			StoreNameState2 & vbCrLf & vbCrLf &_
			"CSV" & vbCrLf & date & "," & time & "," & StoreNameState1 & "," & MySQLstate & "," & ConnectorState & "," & DotNetState &_
			"," & eziscaleState & "," & eziscale45State & "," & eziposState & "," & SerialState & "," & StoreNameState2
			
Blanket_Div.style.visibility="Hidden"
End Sub

Sub CMD
			objShell.Run "cmd /K " & strMySQL & " -h " & Host_IP.Value & " --user=gap -pgap " & Host_DB.Value, 1, False
End Sub

</script>
 <script language="javascript">

function UpdateNotification() { UpdateBar_Div.style.visibility="visible"; }
function UpdateNotificationHidden() { UpdateBar_Div.style.visibility="hidden"; }

function Backup(){
	Header_Div.style.background="#329f50";
	document.getElementById("start").style.background="#329f50";
	Host_Div.style.visibility="visible";
	Target_Div.style.visibility="hidden";
	Location_Div.style.visibility="hidden";
	Toolslist_Div.style.visibility="hidden";
}
function Restore() {
	Header_Div.style.background="#ecae01";
	document.getElementById("start").style.background="#ecae01";
	Host_Div.style.visibility="hidden";
	Target_Div.style.visibility="visible";
	Location_Div.style.visibility="visible";
	Toolslist_Div.style.visibility="hidden";
	
}
function Migrate() {
	Header_Div.style.background="#95519e";
	document.getElementById("start").style.background="#95519e";
	Host_Div.style.visibility="visible";
	Target_Div.style.visibility="visible";
	Location_Div.style.visibility="hidden";
	Toolslist_Div.style.visibility="hidden";
}
function Repair(){
	Header_Div.style.background="#009edf";
	document.getElementById("start").style.background="#009edf";
	Host_Div.style.visibility="visible";
	Target_Div.style.visibility="hidden";
	Location_Div.style.visibility="hidden";
	Toolslist_Div.style.visibility="visible";
}

</script>
</head>
<body align="center">

	<div id="Blanket_Div" class="Blanket_Div">
		<span style="font-size:50px;display: inline-block; vertical-align: middle; color:white;">Please Wait...</span>
	</div>

	<div id="UpdateBar_Div" class="UpdateBar_Div" >
		<a id="Update" onClick="Download">Click here to get the latest version!</a>
		<a id="HideUpdate" style="font-size:12px;" onClick="UpdateNotificationHidden()">(Hide this)</a>
	</div>

	<div id="Header_Div" class="Header_Div">	
		<span id="CompName"></span>
		<br>
		<span id="IP">NO NETWORK DETECTED</span>
		<br>
	</div>
	<p>

	<div id="Main_Div" align="center" style="width:100%; height:85%;">
		<input type="Radio" checked="true" id="backup" name="mode" Value="1" onClick="BackUp()" />
			<label for="backup">Backup</label>
		<input type="Radio" id="restore" name="Mode" Value="2" onClick="Restore()">
			<label for="restore">Restore</label>
		<input type="Radio" id="migrate" name="Mode" Value="3" onClick="Migrate()">
			<label for="migrate">Migrate</label>
		<input type="Radio" id="repair" name="Mode" Value="4" onClick="Repair()">
			<label for="repair">Check & Repair + Tools</label>
		<P>

		<div id="Host_Div" style="visibility: visible; width:400px">
			<h2 align="Left">Host
			<input type="Button" id="test" value="Test" onClick="CheckMySQL1" style="font-size:16px; border:none; color:#e7e7e7; background-color:#555555;"></button>
			<input type="Button" id="CMD" value=" # " onClick="CMD" style="font-size:16px; border:none; color:#e7e7e7; background-color:#555555;"></button>
			</h2>

			IP Address: <input type="text" name="Host_IP" value="localhost" size="10">
			Database: <input type="text" name="Host_DB" value="deliqs" size="10">
			<Span id="DB1Check" style="font-family: monospace; color:Orange;">??</span>
		</div>
		<br>

		<div id="Target_Div" style="visibility: hidden; width:400px">
			<h2 align="Left">Target 
			<input type="Button" id="test2" value="Test" onClick="CheckMySQL2" style="font-size:16px; border:none; color:#e7e7e7; background-color:#555555;"></button>
			</h2>

			IP Address: <input type="text" name="Target_IP" value="localhost" size="10">
			Database: <input type="text" name="Target_DB" value="deliqs" size="10">
			<Span id="DB2Check" style="font-family: monospace; color:Orange;">??</span>
		</div>
		<br>

		<div id="Location_Div" style="visibility: hidden; width:400px">
			<h2 align="Left">File to restore</h2>
			<input type="file" name="fLocation" accept=".sql">
		</div>
		<br>

		<div id="Toolslist_Div" style="visibility: hidden; width:400px">
			<h2 align="Left">Tools</h2>

			<select id="ToolList" name="tools99">
				<option value="1">1. Flush, Check & Repair</option>
				<option value="2">2. Create GaP Users</option>
				<option value="3">3. Convert To InnoDB</option>
				<option value="4">4. Update Product Current Cost</option>
				<option value="5">5. Reset Lane Database</option>
				<option value="6">6. Unlock All Operators</option>
				<option value="7">7. Send External Scale Products</option>
				<option value="8">8. Delete Product by Master GUID</option>
				<option value="9">9. Remove Orphaned Sales</option>
				<option value="10">10. Delete All Products</option>
				<option value="11">11. Cleanup Old Data</option>
				<option value="12">12. Check Lane Status</option>
				<option value="13">13. Update Store Name & Address</option>
				<option value="14">14. List Database Table Sizes</option>
			</select>

		<br>
		<input type="checkbox" id="safetybackup" name="safetybackup" ><label for="safetybackup">Backup first</label></input>
		</div>
		<p>
		<input type="button" id="start" name="Start" value="  Start  " style="font-size:20px; border:none; color:white; background-color:#329f50;" onClick="Start()">
	</div>

	<div id="Footer_Div"  class="Footer_Div">
		<a style="font-size:18px;"> GaP Solutions Pty. Ltd.</a>
		<br>
		<a style="font-size:11px; color:#9f9f9f;">www.gapsolutions.com.au</a>
	</div>

	<div id="Version_Div" class="Version_Div">
		<a id="Help" style="font-size:18px; color:orange;" onClick="Help">Help!</a>
		<br>
		<a id="Checking" style="font-size:11px; text-align:right; color:#0099ff">checking version... </a><a style="font-size:11px;" ondblclick="VersionDetail">Ver: <SPAN ID="AppVersion" style="font-size:11px;">0</SPAN></a>
	</div>

 </body>
 </html>